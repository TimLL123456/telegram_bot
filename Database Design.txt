CREATE TABLE Users (
    user_id BIGINT PRIMARY KEY,
    username VARCHAR(50),
    default_currency VARCHAR(3) NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE Categories (
    category_id SERIAL PRIMARY KEY,
    category_name VARCHAR(50) NOT NULL,
    category_type VARCHAR(10) NOT NULL CHECK (category_type IN ('Income', 'Expense'))
);

CREATE TABLE Transactions (
    transaction_id SERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    amount NUMERIC(10,2) NOT NULL,
    category_id INTEGER NOT NULL,
    description TEXT,
    date DATE NOT NULL,
    currency VARCHAR(3) NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES Users(user_id),
    FOREIGN KEY (category_id) REFERENCES Categories(category_id)
);

CREATE TABLE Transaction_History (
    history_id SERIAL PRIMARY KEY,
    transaction_id INTEGER NOT NULL,
    amount NUMERIC(10,2) NOT NULL,
    category_id INTEGER NOT NULL,
    description TEXT,
    date DATE NOT NULL,
    currency VARCHAR(3) NOT NULL,
    modified_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    modification_type VARCHAR(10) NOT NULL,
    FOREIGN KEY (transaction_id) REFERENCES Transactions(transaction_id),
    FOREIGN KEY (category_id) REFERENCES Categories(category_id)
);

CREATE OR REPLACE FUNCTION log_transaction_insert()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO Transaction_History (
        transaction_id,
        amount,
        category_id,
        description,
        date,
        currency,
        modified_at,
        modification_type
    ) VALUES (
        NEW.transaction_id,
        NEW.amount,
        NEW.category_id,
        NEW.description,
        NEW.date,
        NEW.currency,
        NOW(),
        'INSERT'
    );
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER after_transaction_insert
AFTER INSERT ON Transactions
FOR EACH ROW
EXECUTE FUNCTION log_transaction_insert();

CREATE OR REPLACE FUNCTION log_transaction_update()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO Transaction_History (
        transaction_id,
        amount,
        category_id,
        description,
        date,
        currency,
        modified_at,
        modification_type
    ) VALUES (
        OLD.transaction_id,
        OLD.amount,
        OLD.category_id,
        OLD.description,
        OLD.date,
        OLD.currency,
        NOW(),
        'UPDATE'
    );
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER before_transaction_update
BEFORE UPDATE ON Transactions
FOR EACH ROW
EXECUTE FUNCTION log_transaction_update();

CREATE OR REPLACE FUNCTION log_transaction_delete()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO Transaction_History (
        transaction_id,
        amount,
        category_id,
        description,
        date,
        currency,
        modified_at,
        modification_type
    ) VALUES (
        OLD.transaction_id,
        OLD.amount,
        OLD.category_id,
        OLD.description,
        OLD.date,
        OLD.currency,
        NOW(),
        'DELETE'
    );
    RETURN OLD;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER before_transaction_delete
BEFORE DELETE ON Transactions
FOR EACH ROW
EXECUTE FUNCTION log_transaction_delete();

CREATE INDEX idx_transaction_history_transaction_id ON Transaction_History(transaction_id);
CREATE INDEX idx_transaction_history_modified_at ON Transaction_History(modified_at);