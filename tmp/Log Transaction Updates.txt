CREATE OR REPLACE FUNCTION log_transaction_update()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO Transaction_History (
        transaction_id,
        date,
        category_id,
        description,
        currency,
        amount,
        modified_at,
        modification_type
    ) VALUES (
        NEW.transaction_id,
        NEW.date,
        NEW.category_id,
        NEW.description,
        NEW.currency,
        NEW.amount,
        NOW(),
        'UPDATE'
    );
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE OR REPLACE TRIGGER before_transaction_update
BEFORE UPDATE ON Transactions
FOR EACH ROW
EXECUTE FUNCTION log_transaction_update();